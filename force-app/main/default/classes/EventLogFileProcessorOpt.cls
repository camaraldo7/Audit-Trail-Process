/**
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚                     EVENT LOG FILE PROCESSOR OPT                         â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ Traitement optimisÃ© des fichiers journaux d'Ã©vÃ©nements Salesforce        â”‚
 * â”‚ Version: 1.0                                                             â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * @description       : 
 * @author            : Mamadou Lamine CAMARA
 * @group             : 
 * @last modified on  : 20-04-2025 
 * @last modified by  : Mamadou Lamine CAMARA
**/

public class EventLogFileProcessorOpt {
    
    //â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    //â”‚    CONSTANTES                           â”‚
    //â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    private static final String USER_ID_FIELD = 'UserId';
    private static final Integer BATCH_SIZE = 200;
    
    //â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    //â”‚    CLASSES INTERNES                     â”‚
    //â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    public class EventLogInfo {
        public Id logFileId { get; set; }
        public String eventType { get; set; }
        public Id userId { get; set; }
        public String logContent { get; set; }
        public Map<String, Object> additionalInfo { get; set; }
        
        public EventLogInfo() {
            this.additionalInfo = new Map<String, Object>();
        }
    }
    
    public class EventLogProcessorException extends Exception {}
    
    //â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    //â”‚    MÃ‰THODES PRINCIPALES                 â”‚
    //â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    /**
     * @description RÃ©cupÃ¨re les fichiers journaux dans une plage de dates
     * @param startDate Date de dÃ©but
     * @param endDate Date de fin
     * @return Liste des fichiers journaux
     */
    public List<EventLogFile> getEventLogFiles(Date startDate, Date endDate) {
        // ğŸ” Validation des dates
        if (startDate == null || endDate == null) {
            throw new EventLogProcessorException('Les dates de dÃ©but et de fin sont requises');
        }
        if (startDate > endDate) {
            throw new EventLogProcessorException('La date de dÃ©but doit Ãªtre antÃ©rieure Ã  la date de fin');
        }
        
        // ğŸ“‹ RÃ©cupÃ©ration des logs
        return [
            SELECT Id, EventType, LogDate, LogFile, LogFileLength
            FROM EventLogFile
            WHERE LogDate >= :startDate
            AND LogDate <= :endDate
            ORDER BY LogDate DESC
            LIMIT :BATCH_SIZE
        ];
    }
    
    /**
     * @description Traite les fichiers journaux dans une plage de dates
     * @param startDate Date de dÃ©but
     * @param endDate Date de fin
     * @return Liste des informations extraites
     */
    public List<EventLogInfo> processEventLogs(Date startDate, Date endDate) {
        List<EventLogInfo> results = new List<EventLogInfo>();
        
        // ğŸ“¥ RÃ©cupÃ©ration des logs
        List<EventLogFile> logFiles = getEventLogFiles(startDate, endDate);
        
        // ğŸ”„ Traitement de chaque log
        for (EventLogFile logFile : logFiles) {
            EventLogInfo info = processEventLogFile(logFile);
            if (info != null) {
                results.add(info);
            }
        }
        
        return results;
    }
    
    /**
     * @description Traite un fichier journal individuel
     * @param logFile Fichier journal Ã  traiter
     * @return Informations extraites du log
     */
    public EventLogInfo processEventLogFile(EventLogFile logFile) {
        EventLogInfo info = new EventLogInfo();
        info.logFileId = logFile.Id;
        info.eventType = logFile.EventType;
        
        try {
            // ğŸ“„ Lecture du contenu
            String content = logFile.LogFile.toString();
            info.logContent = content;
            
            // ğŸ” Extraction des informations selon le format
            if (content.startsWith('{')) {
                processJSONContent(content, info);
            } else if (content.contains(',')) {
                processCSVContent(content, info);
            } else {
                info.eventType = 'Unknown';
            }
            
        } catch (Exception e) {
            // âš ï¸ Gestion des erreurs
            System.debug(LoggingLevel.ERROR, 'Erreur lors du traitement du log: ' + e.getMessage());
            info.eventType = 'Unknown';
        }
        
        return info;
    }
    
    //â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    //â”‚    MÃ‰THODES D'EXTRACTION                â”‚
    //â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    /**
     * @description Traite le contenu au format JSON
     * @param content Contenu JSON
     * @param info Objet Ã  remplir
     */
    private void processJSONContent(String content, EventLogInfo info) {
        Map<String, Object> jsonData = (Map<String, Object>)JSON.deserializeUntyped(content);
        
        // ğŸ‘¤ Extraction de l'ID utilisateur
        if (jsonData.containsKey(USER_ID_FIELD)) {
            info.userId = (Id)jsonData.get(USER_ID_FIELD);
        }
        
        // ğŸ“Š Extraction des informations supplÃ©mentaires selon le type
        extractAdditionalInfo(jsonData, info);
    }
    
    /**
     * @description Traite le contenu au format CSV
     * @param content Contenu CSV
     * @param info Objet Ã  remplir
     */
    private void processCSVContent(String content, EventLogInfo info) {
        List<String> lines = content.split('\n');
        if (lines.size() < 2) return;
        
        // ğŸ“‘ Analyse des en-tÃªtes et des valeurs
        List<String> headers = lines[0].split(',');
        List<String> values = lines[1].split(',');
        
        Map<String, String> csvData = new Map<String, String>();
        for (Integer i = 0; i < headers.size() && i < values.size(); i++) {
            csvData.put(headers[i].trim(), values[i].trim());
        }
        
        // ğŸ‘¤ Extraction de l'ID utilisateur
        if (csvData.containsKey(USER_ID_FIELD)) {
            info.userId = (Id)csvData.get(USER_ID_FIELD);
        }
        
        // ğŸ“Š Ajout des informations supplÃ©mentaires
        for (String header : csvData.keySet()) {
            if (header != USER_ID_FIELD) {
                info.additionalInfo.put(header, csvData.get(header));
            }
        }
    }
    
    /**
     * @description Extrait les informations supplÃ©mentaires selon le type d'Ã©vÃ©nement
     * @param jsonData DonnÃ©es JSON
     * @param info Objet Ã  remplir
     */
    private void extractAdditionalInfo(Map<String, Object> jsonData, EventLogInfo info) {
        for (String key : jsonData.keySet()) {
            if (key != USER_ID_FIELD && key != 'EventType') {
                info.additionalInfo.put(key, jsonData.get(key));
            }
        }
    }
} 